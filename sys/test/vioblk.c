#include "conf.h"
#include "assert.h"
#include "intr.h"
#include "device.h"
#include "thread.h"
#include "heap.h"
#include "dev/virtio.h"
#include "dev/uart.h"
#include "timer.h"

char * art =
"\n         _nnnn_        \n"
"        dGGGGMMb        \n"
"       @p~qp~~qMb       \n"
"       M|@||@) M|       \n"
"       @,----.JM|       \n"
"      JS^  _/  qKL      \n"
"     dZP        qKRb    \n"
"    dZP          qKKb   \n"
"   fZP            SMMb  \n"
"   HZM            MMMM  \n"
"   FqM            MMMM  \n"
" __| .        | S qML   \n"
" |    `.       | `' q   \n"
"_)       ___.,|     .'  \n"
" ___   )MMMMMP|   .'    \n"
"     `-'       `--' hjm\n\0";

char * lev =
"\n****************************************************************************************#*##########\n"
"*****************************************************************************************###########\n"
"******************************************************************************************##########\n"
"*********************************************************************************************#######\n"
"**************************************************###****************************************#*#####\n"
"****************************************+++*+****   %###  %#************************************#*##\n"
"*************************************++++*+**+*########  %@@%  ##**********************************##\n"
"************************************++++++++++***##*****#%@@%####***#******************************#\n"
"*******************************+**+*+++++++*++*++*#**#*+*%*++*####*#********************************\n"
"********************************+***++***+***##*#*#+******+****+*###*+******************************\n"
"****************************#**+*++**********#***#*****###***#*******##*+#**************************\n"
"*********************************+***+***+**+***+***+*%####**#*#*####*###***************************\n"
"**************************##***+##***#+******#*++**#**###***#+*****##**#***#************************\n"
"*************************###*#####%#######**###**%*#****#*****+=+**++###***#************************\n"
"*******************+++++###*#####*###*######*###****++++*+++++*+=+=*++*****#************************\n"
"*************++++++++++*##*##%###%#########*****+#*+=++=*++++=+===-=***+*#**************************\n"
"**********+++++++++++++**#**#*##*%######  #####+*+++=+=+++===--===--+++*++**#***********************\n"
"****+++++++++++++++++++*#********####%##%###*#***++====+===--:--===-+=+*++***#**********************\n"
"***+++++++++++++++++++++##**+++++**#########****+===--=-----------+-=+**++++##**********************\n"
"++++++++++++++++++++++++***++*==++++######++++==---:--:::::::-----=+-=*++***#%**********************\n"
"++++++++++++++++++++++++***+*%===+=+**+*+====----::::::::--:::-----==+=++#%**%*+++******************\n"
"++++++++++++++++++++++++++++%#==--==+===-==--------=+++==-----------#*#+**%+##++++++****************\n"
"+++++++++++++++++++++++++++*%*===+++++**++=------=+*=++++++=-----+#---++#**+*=*+++++*+**************\n"
"+++++++++++++++++++++++++++*%+=++*++++++*+*-+=-==+==+**=*@*-+====-::---*+*+++-+++++++++++***********\n"
"++++++++++++++++++++++++++++##++=+##+#@%*%#+=+-:=+:---====-------:::---=**++==++++++++++++**********\n"
"++++++++++++++++++++++++++++*==-=+======+++*#+-::+-----==------=:::----=++=--+++++++++++++++********\n"
"++++++++++++++++++++++++++++*==--=======--=++=-:::=::--------:*::::----=+----++++++++++++++++*******\n"
"++++++++++++++++++++++++++++*=-------------===-::::----++=:-:::::::----==--==+++++++++++++++++++****\n"
"++++++++++++++++++++++++++=+===--=++=+*=--===--::::-------::::::------===--=+++++++++++++++++++++***\n"
"++++++++++++++++++++++++=========--------=+==--:::::--=+=------------======+++++++++++++++++++++++**\n"
"++++++++++++++++++================------=**=+===-=+%+-:-+==---------====  ++++++++++++++++++++++++*+\n"
"+++++++++++++++======================-==+*++****++=---::--+---------==-=@*++++++++++++++++++++++++++\n"
"++++++++++++=====================++===+++++++====-----------------======*+++++++++++++++++++++++++++\n"
"++++++++========================++++====++====----------==------=---====++++++++++++++++++++++++++++\n"
"+++==============================+++=-=+#@@**+*+++==-+=*=++=------====+=+=+=++++++++++++++++++++++++\n"
"++===============================++++=============---------=------==++-+@+===+++++++++++++++++++++++\n"
"==================================++++=======+++===-------------===++==*@  ====+++++++++++++++++++++\n"
"===================================++++========+===-------------=+*+=-=*    ======++++++++++++++++++\n"
"=====================================++++========-------------==*+==--+=@    #======++++++++++++++++\n"
"======================================+++==----------------==+**===--=-*      %+=====+++++++++++++++\n"
"=======================================++++==------------==+**+==--=--=          =====++++++++++++++\n"
"=====================================+%*++++++==========+***+===-=---=             *===+++++++++++++\n\0";

char read_buf[512*9];

void test_read(struct io * blkio, long pos, long size);
void test_write(struct io * blkio, long pos, void * buf, long size);

void main(void) {
    extern char _kimg_end[];
    struct io * blkio;
    int result;
    int i;

    intrmgr_init();
    timer_init();
    devmgr_init();
    thrmgr_init();

    heap_init(_kimg_end, RAM_END);

    for (i = 0; i < 3; i++)
        uart_attach((void*)UART_MMIO_BASE(i), UART_INTR_SRCNO(i));

    for (i = 0; i < 8; i++)
        virtio_attach((void*)VIRTIO_MMIO_BASE(i), VIRTIO_INTR_SRCNO(i));

    result = open_device("vioblk", 0, &blkio);
    assert (result == 0);

    enable_interrupts();

    uint64_t size = 0;
    uint64_t pos = 0;

    while (art[size] != '\0')
        size++;

    //if (size % 512 != 0)
    //    size += size % 512;

    size = 512;

    test_write(blkio, pos, (char*)art, size);
    test_read(blkio, pos, size);

    pos = 512;
    test_write(blkio, pos, (char*)art, size);
    test_read(blkio, pos, size);

    pos = 0;
    test_read(blkio, pos, size);

    pos = 512*2;
    test_read(blkio, pos, size);

    while (lev[size] != '\0')
        size++;

    pos = 0;
    size = 512*9;
    test_write(blkio, pos, (char*)lev, size);
    test_read(blkio, pos, size);
}

void test_read(struct io * blkio, long pos, long size) {
    kprintf("Reading from vioblk\n");
    kprintf("pos=%d\n", pos);
    kprintf("size=%d\n", size);

    long len = ioreadat(blkio, pos, (char*)read_buf, size);

    kprintf("len=%d\n", len);

    for (int i = 0; i < len; i++)
        kprintf("%c", read_buf[i]);
}

void test_write(struct io * blkio, long pos, void * buf, long size) {
    kprintf("Writing to vioblk\n");
    kprintf("pos=%d\n", pos);
    kprintf("size=%d\n", size);

    long len = iowriteat(blkio, pos, buf, size);

    kprintf("len=%d\n", len);

    for (int i = 0; i < len; i++)
        kprintf("%c", ((char*)buf)[i]);
}
